<!DOCTYPE html>
<html>
    <head>
        <style>
            section {
                display: grid;
                gap: 1rem;
                /* grid-template-columns: repeat(6, 1fr); */
                grid-template-columns: "choices" "answer";
                justify-items: center;

                margin: 1rem;
            }

            .choice {
                width: 10rem;
                height: 10rem;
            }

            #choices {
                grid-area: "choices";
                
                display: flex;
                gap: 6rem;
            }

            #answer {
                grid-area: "answer";
            }

            .hidden {
                content-visibility: hidden;
                visibility: hidden;
            }
        </style>

    </head>
    <body>
        <button id="downloadData">Download Data</button>
        <button id="removeCookies">Remove Cookies</button>

        <main>
            <section class="hidden">
                <div id="choices">
                    <div class="choice"></div>
                    <div class="choice"></div>
                </div>
                <div class="choice" id="answer"></div>
            </section>
            <button id="startbutton">Start</button>

            <script type="module">
                import Cookies from 'https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/+esm'

                let choicesCounter = 0
                const cookieChoice = (obj) => Cookies.set(choicesCounter++, JSON.stringify(obj))

                const { random } = Math

                const colors = [
                    "#ff0c00",
                    "#5d5700",
                    "#027752",
                    "#ffff00",
                    "#4200ff",
                    "#800063"
                ]

                const choicesElement  = document.getElementById("choices")
                const answerElement = document.getElementById("answer")

                let choice1, choice2, answer, startTime

                function choiceSelected ( choice ) {
                    // TODO: Get end time and use it.
                    cookieChoice({
                        choice,
                        correct: choice === answer,
                        duration: Date.now() - startTime
                    })
                    const firstChoice = choicesElement.children[0]
                    const secondChoice = choicesElement.children[1]
                    firstChoice.style.backgroundColor = secondChoice.style.backgroundColor = answerElement.style.backgroundColor = "white"
                    firstChoice.onclick = secondChoice.onclick = () => {}

                    createNewChoices()
                }
                // FIXME: Something feels off about the randomness of the choices.
                const randomRanged = (max, min) => Math.floor( Math.random() * ( max - min + 1 ) + min )

                function createChoices () {
                    // FIXME: This is probably not the best way to pick the two random numbers.
                    choice1 = randomRanged(0, colors.length - 1)
                    choice2 = randomRanged(0, colors.length - 1)
                    while(choice1 === choice2)
                        choice2 = randomRanged(0, colors.length - 1)

                    // console.log({ choice1, choice2 }) // Debug logging

                    answer = random() > 0.5 ? choice1 : choice2
                }

                const createNewChoices = () => setTimeout(() => {
                    createChoices()

                    const firstChoice = choicesElement.children[0]
                    firstChoice.style.backgroundColor = colors[choice1]
                    firstChoice.onclick = () => choiceSelected( choice1 )

                    const secondChoice = choicesElement.children[1]
                    secondChoice.style.backgroundColor = colors[choice2]
                    secondChoice.onclick = () => choiceSelected( choice2 )

                    answerElement.style.backgroundColor = colors[answer]

                    startTime = Date.now()
                }, 1000)

                function startTesting () {
                    document.getElementsByClassName("hidden")[0].className = ""
                    document.getElementById("startbutton").className = "hidden"
                    createNewChoices()
                }
                document.getElementById("startbutton").onclick = startTesting

                // Created by: https://stackoverflow.com/questions/3665115/how-to-create-a-file-in-memory-for-user-to-download-but-not-through-server#answer-18197341
                // Modified by: Jake D'Esposito
                // BUG: The data that it writes out the the file is correct, all that is wrong is that an extra backslash needs to be put in where ever there is a backslash.
                function downloadData () {
                    const filename = "data.json"
                    const text = JSON.stringify(Cookies.get())
                    
                    var element = document.createElement('a')
                    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text))
                    element.setAttribute('download', filename)

                    element.style.display = 'none'
                    document.body.appendChild(element)

                    element.click()

                    document.body.removeChild(element)
                }
                document.getElementById("downloadData").onclick = downloadData

                function removeCookies () {
                    if(confirm("You are about to removed the data!\nAre you sure you want to do this?"))
                        for (const cookie in Cookies.get())
                            Cookies.remove(cookie)
                }
                document.getElementById("removeCookies").onclick = removeCookies
            </script>
        </main>

        <!-- <main>
            <div style="background-color: #ff0c00;"></div>
            <div style="background-color: #5d5700;"></div>
            <div style="background-color: #027752;"></div>
            <div style="background-color: #ffff00;"></div>
            <div style="background-color: #4200ff;"></div>
            <div style="background-color: #800063;"></div>
        </main> -->

    </body>
</html>